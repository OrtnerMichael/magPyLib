# here all core functions should be tested properly - ideally against FEM
import numpy as np

from magpylib._src.fields.field_BH_sphere import magnet_sphere_Bfield
from magpylib._src.fields.field_BH_current_sheet import BHJM_current_sheet

def test_magnet_sphere_Bfield():
    "magnet_sphere_Bfield test"
    B = magnet_sphere_Bfield(
        observers=np.array([(0, 0, 0)]),
        diameters=np.array([1]),
        polarizations=np.array([(0, 0, 1)]),
    )
    Btest = np.array([(0, 0, 2 / 3)])
    np.testing.assert_allclose(B, Btest)


def test_current_sheet_Bfield():
    "test egainst BEM"

    # test 1

    observers = np.array((
        ( 4.881350392732475285e-01,  2.151893663724194994e+00,  1.027633760716438971e+00),
        ( 4.488318299689684210e-01, -7.634520066109526937e-01,  1.458941130666561392e+00),
        (-6.241278873730751187e-01,  3.917730007820797056e+00,  4.636627605010293252e+00),
        (-1.165584811742222726e+00,  2.917250380826645895e+00,  2.889491975290443548e-01),
        ( 6.804456109393228758e-01,  4.255966382926610336e+00, -4.289639418021130801e+00),
        (-4.128707002984592478e+00, -4.797816025596742584e+00,  3.326198455479380200e+00),
        ( 2.781567509498504620e+00,  3.700121482468190948e+00,  4.786183422327640713e+00),
        ( 2.991585642167235548e+00, -3.852063774706815380e-01,  2.805291762864554173e+00),
        (-3.817255741310667805e+00,  1.399210213275238424e+00, -3.566467125909535962e+00),
        ( 4.446689170495838894e+00,  2.184832175007169752e-01, -8.533806000947645742e-01),
        (-1.000000000000000000e+00,  0.000000000000000000e+00,  0.000000000000000000e+00),
        ( 2.000000000000000000e+00,  0.000000000000000000e+00,  0.000000000000000000e+00),
        ( 0.000000000000000000e+00, -1.000000000000000000e+00,  0.000000000000000000e+00),
        ( 0.000000000000000000e+00,  2.000000000000000000e+00,  0.000000000000000000e+00),
        ( 2.000000000000000000e+00, -1.000000000000000000e+00,  0.000000000000000000e+00),
        (-1.000000000000000000e+00,  2.000000000000000000e+00,  0.000000000000000000e+00),
        (-1.000000000000000000e+00,  2.000000000000000000e+00,  1.000000000000000000e+00),
        (-1.000000000000000000e+00,  2.000000000000000000e+00, -1.000000000000000000e+00)
    ))

    n = len(observers)

    coordinates = np.tile(np.array((1,0,1)).T, (n,1))
    current_densities = np.tile(np.array((1,1)).T, (n,1))

    B_field_current_sheet = BHJM_current_sheet(
        'B',
        observers,
        coordinates,
        current_densities,
    ) 

    B_BEM = -np.array((
        (-5.77021E-09,   5.77021E-09,  -8.75240E-09),
        (-1.18724E-08,   1.18724E-08,   9.24139E-09),
        (-1.10847E-09,   1.10847E-09,  -1.07797E-09),
        (-5.62891E-10,   5.62891E-10,  -7.72038E-09),
        ( 1.08663E-09,  -1.08663E-09,  -8.98825E-10),
        (-3.83528E-10,   3.83528E-10,   7.68352E-11),
        (-9.35900E-10,   9.35900E-10,  -1.78456E-10),
        (-2.32377E-09,   2.32377E-09,   2.75055E-09),
        ( 1.03337E-09,  -1.03337E-09,  -1.49974E-09),
        ( 5.83738E-10,  -5.83738E-10,   2.84827E-09),
        ( 0.00000E+00,   0.00000E+00,  -1.88245E-08),
        ( 0.00000E+00,   0.00000E+00,   2.11957E-08),
        ( 0.00000E+00,   0.00000E+00,   1.88245E-08),
        ( 0.00000E+00,   0.00000E+00,  -2.11957E-08),
        ( 0.00000E+00,   0.00000E+00,   1.62116E-08),
        ( 0.00000E+00,   0.00000E+00,  -1.62116E-08),
        (-4.07319E-09,   4.07319E-09,  -1.16537E-08),
        ( 4.07319E-09,  -4.07319E-09,  -1.16537E-08)
    ))

    np.testing.assert_allclose(B_BEM, B_field_current_sheet, rtol=1e-3)


    # test 2

    observers = np.array((
        ( 1.085110023512870114e+00,  2.601622467210790379e+00, -9.994281259132755668e-01),
        ( 5.116628631591988441e-01, -2.662205459144347808e-01, -5.383070261560110037e-01),
        (-6.869894311164548295e-02,  7.278036352152388311e-01,  9.838373711533496824e-01),
        ( 1.694083670016784726e+00,  1.095972572016473912e+00,  2.426097501983797589e+00),
        ( 2.226124865758727367e-02,  3.390587181954726859e+00, -8.630620340103691834e-01),
        ( 2.352337550892011020e+00,  1.086524011835634962e+00,  1.793449142228758397e+00),
        (-2.980653070238311608e-01, -9.492554575606049205e-03,  3.003722843377683027e+00),
        ( 3.841307878596987635e+00,  5.671208907962141943e-01,  2.461613078346570394e+00),
        ( 3.381945761480191770e+00,  3.473033317519236718e+00, -5.747789431511104441e-01),
        (-8.047260838355881907e-01, -1.508479021771554907e-01,  3.390712517147065341e+00),
        (-1.000000000000000000e+00,  0.000000000000000000e+00,  0.000000000000000000e+00),
        ( 2.000000000000000000e+00,  0.000000000000000000e+00,  0.000000000000000000e+00),
        ( 0.000000000000000000e+00, -5.000000000000000000e-01,  0.000000000000000000e+00),
        ( 4.000000000000000000e+00,  1.500000000000000000e+00,  0.000000000000000000e+00),
        (-1.000000000000000000e+00, -3.333333333333333148e-01,  0.000000000000000000e+00),
        ( 4.000000000000000000e+00,  1.333333333333333259e+00,  0.000000000000000000e+00),
        ( 3.000000000000000000e+00,  5.000000000000000000e-01,  0.000000000000000000e+00),
        ( 1.000000000000000000e+00,  1.000000000000000000e+00,  0.000000000000000000e+00)
    ))

    n = len(observers)

    coordinates = np.tile(np.array((1,3,1)).T, (n,1))
    current_densities = np.tile(np.array((0,1)).T, (n,1))

    B_field_current_sheet = BHJM_current_sheet(
        'B',
        observers,
        coordinates,
        current_densities,
    ) 

    print(B_field_current_sheet)

    B_BEM = -np.array((
        ( 2.97753E-09,   0.00000E+00,  -9.52609E-10),
        ( 3.54616E-08,   0.00000E+00,  -1.98893E-08),
        (-1.08746E-08,   0.00000E+00,  -1.14881E-08),
        (-6.63081E-09,   0.00000E+00,   7.76358E-10),
        ( 1.01150E-09,   0.00000E+00,  -1.50189E-09),
        (-8.61664E-09,   0.00000E+00,   3.69544E-09),
        (-3.72730E-09,   0.00000E+00,  -1.83084E-09),
        (-3.00527E-09,   0.00000E+00,   2.76868E-09),
        ( 5.83104E-10,   0.00000E+00,   1.79762E-09),
        (-2.61711E-09,   0.00000E+00,  -1.53289E-09),
        ( 0.00000E+00,   0.00000E+00,  -1.13296E-08),
        ( 0.00000E+00,   0.00000E+00,   4.27313E-08),
        ( 0.00000E+00,   0.00000E+00,  -2.41300E-08),
        ( 0.00000E+00,   0.00000E+00,   6.59267E-09),
        ( 0.00000E+00,   0.00000E+00,  -1.03229E-08),
        ( 0.00000E+00,   0.00000E+00,   7.17046E-09),
        ( 0.00000E+00,   0.00000E+00,   2.94875E-08),
        ( 0.00000E+00,   0.00000E+00,  -1.70749E-08)
    ))

    np.testing.assert_allclose(B_BEM, B_field_current_sheet, rtol=1e-3)

